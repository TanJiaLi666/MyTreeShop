<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.tulingxueyuan.mall.modules.sms.mapper.SmsFlashPromotionProductRelationMapper">

    <!-- 通用查询映射结果 -->
    <resultMap id="BaseResultMap" type="com.tulingxueyuan.mall.modules.sms.model.SmsFlashPromotionProductRelation">
        <id column="id" property="id" />
        <result column="flash_promotion_id" property="flashPromotionId" />
        <result column="flash_promotion_session_id" property="flashPromotionSessionId" />
        <result column="product_id" property="productId" />
        <result column="flash_promotion_price" property="flashPromotionPrice" />
        <result column="flash_promotion_count" property="flashPromotionCount" />
        <result column="flash_promotion_limit" property="flashPromotionLimit" />
        <result column="sort" property="sort" />
    </resultMap>
    <resultMap id="List" type="com.tulingxueyuan.mall.modules.sms.model.dto.FlashPromotionProductRelationDTO">
        <id column="id" property="id" />
        <result column="flash_promotion_price" property="flashPromotionPrice" />
        <result column="flash_promotion_count" property="flashPromotionCount" />
        <result column="flash_promotion_limit" property="flashPromotionLimit" />
        <result column="sort" property="sort" />
        <collection property="product" ofType="com.tulingxueyuan.mall.modules.pms.model.PmsProduct">
            <result column="name" property="name"/>
            <result column="product_sn" property="productSn"/>
            <result column="price" property="price"/>
            <result column="stock" property="stock"/>
        </collection>
    </resultMap>
    <select id="fetchSelectList"
            parameterType="com.tulingxueyuan.mall.modules.sms.model.dto.FlashPromotionProductRelationDTO"
            resultType="com.tulingxueyuan.mall.modules.sms.model.dto.FlashPromotionProductRelationDTO">
        SELECT
            re.`flash_promotion_session_id` as id,
            se.`name` as name,
            se.`start_time` as startTime,
            se.`end_time` as endTime,
            COUNT(re.`product_id`) AS productCount
        FROM
            `sms_flash_promotion_product_relation` re
        LEFT JOIN
            `sms_flash_promotion_session` se ON  se.`id`=re.`flash_promotion_session_id`
        WHERE
            re.`flash_promotion_id`=#{flashPromotionId}
        GROUP BY re.`flash_promotion_session_id`
    </select>
    <select id="fetchList"
            resultMap="List">
        SELECT
            re.`id`,
            pr.`name`,
            pr.`product_sn`,
            pr.`price`,
            pr.`stock`,
            re.`flash_promotion_price`,
            re.`flash_promotion_count`,
            re.`flash_promotion_limit`,
            re.`sort`
        FROM
            `sms_flash_promotion_product_relation` re
        JOIN
            `pms_product` pr ON re.`product_id`=pr.`id`
        WHERE
            re.`flash_promotion_id`=#{relationDTO.flashPromotionId} AND re.`flash_promotion_session_id`=#{relationDTO.flashPromotionSessionId}
        order by re.`sort`
    </select>
</mapper>
